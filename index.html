<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSB 功能测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-group {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-group h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-item {
            margin-bottom: 5px;
        }

        .log-success { color: #4caf50; }
        .log-error { color: #f44336; }
        .log-warn { color: #ff9800; }
        .log-info { color: #2196f3; }

        .status-good { color: green; }
        .status-bad { color: red; }
        .status-warn { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>JSB 功能测试</h1>
            <p>测试各种 JavaScript Bridge 功能</p>
            <div id="jsb-status" style="margin-top: 10px;"></div>
        </div>

        <!-- 基础信息测试 -->
        <div class="test-group">
            <h3>基础信息检测</h3>
            <button class="btn" onclick="testIsInDarkMode()">检测暗黑模式</button>
            <button class="btn" onclick="testIsInTalkBackMode()">检测TalkBack模式</button>
            <button class="btn" onclick="testGetSystemInfo()">获取系统信息</button>
            <div id="basic-result" class="result" style="display: none;"></div>
        </div>

        <!-- Toast 和 Dialog 测试 -->
        <div class="test-group">
            <h3>UI 交互测试</h3>
            <button class="btn" onclick="testShowToast()">显示 Toast</button>
            <button class="btn" onclick="testShowSimpleDialog()">简单对话框</button>
            <button class="btn" onclick="testShowComplexDialog()">复杂对话框</button>
            <div id="ui-result" class="result" style="display: none;"></div>
        </div>

        <!-- 页面操作测试 -->
        <div class="test-group">
            <h3>页面操作测试</h3>
            <button class="btn" onclick="testStartPage()">打开新页面</button>
            <button class="btn btn-danger" onclick="testClosePage('cancel')">关闭页面(取消)</button>
            <button class="btn btn-success" onclick="testClosePage('success')">关闭页面(成功)</button>
            
            <div class="input-group" style="margin-top: 15px;">
                <label>自定义 URL:</label>
                <input type="text" id="custom-url" placeholder="例如: https://www.xiaomi.com" value="https://www.xiaomi.com">
            </div>
            <button class="btn" onclick="testStartCustomPage()">打开自定义页面</button>
            
            <div id="page-result" class="result" style="display: none;"></div>
        </div>

        <!-- 调试信息 -->
        <div class="test-group">
            <h3>调试信息</h3>
            <button class="btn" onclick="debugJSB()">检查 JSB 对象</button>
            <button class="btn" onclick="testDirectCall()">直接调用测试</button>
            <button class="btn" onclick="testAllMethods()">尝试所有可能的调用方式</button>
            <div id="debug-result" class="result" style="display: none;"></div>
        </div>

        <!-- 日志 -->
        <div class="log" id="log"></div>
    </div>

    <script>
        // 日志功能
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${time}] ${message}`;
            logEl.appendChild(logItem);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        // 显示结果
        function showResult(elementId, data) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.textContent = JSON.stringify(data, null, 2);
        }

        // 检查 JSB 可用性
        function checkJSB() {
            log('检查 JSB 可用性...', 'info');
            
            // 检查 PASSPORT_JSB_METHOD_INVOKER 是否存在
            if (typeof window.PASSPORT_JSB_METHOD_INVOKER === 'undefined') {
                log('window.PASSPORT_JSB_METHOD_INVOKER 未定义', 'error');
                return false;
            }
            
            log(`PASSPORT_JSB_METHOD_INVOKER 存在，类型: ${typeof window.PASSPORT_JSB_METHOD_INVOKER}`, 'success');
            
            // 检查是否有 invoke 方法
            if (window.PASSPORT_JSB_METHOD_INVOKER.invoke) {
                log(`invoke 方法存在，类型: ${typeof window.PASSPORT_JSB_METHOD_INVOKER.invoke}`, 'success');
                return true;
            } else {
                log('invoke 方法不存在', 'error');
                return false;
            }
        }

        // 安全的 JSB 调用
        function callJSB(methodName, params = {}) {
            if (!checkJSB()) {
                throw new Error('JSB 不可用');
            }
            
            try {
                log(`调用: ${methodName}`, 'info');
                log(`参数: ${JSON.stringify(params)}`, 'info');
                
                // 使用 invoke 方法调用
                const result = window.PASSPORT_JSB_METHOD_INVOKER.invoke(methodName, params);
                log(`${methodName} 返回: ${JSON.stringify(result)}`, 'success');
                return result;
                
            } catch (error) {
                log(`${methodName} 错误: ${error.message}`, 'error');
                log(`错误堆栈: ${error.stack}`, 'error');
                throw error;
            }
        }

        // ===== 调试功能 =====
        
        function debugJSB() {
            log('开始调试 JSB...', 'info');
            
            const debugInfo = {};
            
            // 检查 window 对象中相关的属性
            const passportKeys = Object.keys(window).filter(key => 
                key.includes('PASSPORT') || 
                key.includes('JSB') || 
                key.includes('Bridge') ||
                key.includes('bridge')
            );
            debugInfo.relatedKeys = passportKeys;
            
            // 详细检查 PASSPORT_JSB_METHOD_INVOKER
            if (window.PASSPORT_JSB_METHOD_INVOKER) {
                debugInfo.jsbObject = {
                    type: typeof window.PASSPORT_JSB_METHOD_INVOKER,
                    constructor: window.PASSPORT_JSB_METHOD_INVOKER.constructor.name,
                    properties: Object.getOwnPropertyNames(window.PASSPORT_JSB_METHOD_INVOKER),
                    methods: []
                };
                
                // 检查所有属性
                Object.getOwnPropertyNames(window.PASSPORT_JSB_METHOD_INVOKER).forEach(prop => {
                    const propType = typeof window.PASSPORT_JSB_METHOD_INVOKER[prop];
                    if (propType === 'function') {
                        debugInfo.jsbObject.methods.push(prop);
                    }
                });
                
                // 特别检查 invoke 方法
                if (window.PASSPORT_JSB_METHOD_INVOKER.invoke) {
                    debugInfo.invokeMethod = {
                        type: typeof window.PASSPORT_JSB_METHOD_INVOKER.invoke,
                        toString: window.PASSPORT_JSB_METHOD_INVOKER.invoke.toString()
                    };
                }
            } else {
                debugInfo.jsbObject = null;
            }
            
            showResult('debug-result', debugInfo);
            log('调试信息已显示', 'info');
        }

        function testDirectCall() {
            try {
                log('尝试直接调用...', 'info');
                
                if (!window.PASSPORT_JSB_METHOD_INVOKER) {
                    throw new Error('PASSPORT_JSB_METHOD_INVOKER 不存在');
                }
                
                if (!window.PASSPORT_JSB_METHOD_INVOKER.invoke) {
                    throw new Error('invoke 方法不存在');
                }
                
                // 尝试最简单的调用
                log('开始调用 invoke 方法...', 'info');
                const result = window.PASSPORT_JSB_METHOD_INVOKER.invoke('isInDarkMode', {});
                
                showResult('debug-result', { 
                    success: true,
                    result: result,
                    resultType: typeof result
                });
                
            } catch (error) {
                log(`直接调用失败: ${error.message}`, 'error');
                showResult('debug-result', { 
                    success: false,
                    error: error.message, 
                    stack: error.stack 
                });
            }
        }

        function testAllMethods() {
            log('测试所有可能的调用方式...', 'info');
            const results = {};
            
            // 方式1: 直接调用 invoke
            try {
                results.method1 = window.PASSPORT_JSB_METHOD_INVOKER.invoke('isInDarkMode', {});
                log('方式1成功: 直接调用 invoke', 'success');
            } catch (error) {
                results.method1 = { error: error.message };
                log(`方式1失败: ${error.message}`, 'error');
            }
            
            // 方式2: 尝试带回调的调用
            try {
                results.method2 = window.PASSPORT_JSB_METHOD_INVOKER.invoke('isInDarkMode', {}, function(result) {
                    log('回调被调用: ' + JSON.stringify(result), 'info');
                });
                log('方式2成功: 带回调调用', 'success');
            } catch (error) {
                results.method2 = { error: error.message };
                log(`方式2失败: ${error.message}`, 'error');
            }
            
            // 方式3: 检查是否有其他调用方法
            try {
                if (window.PASSPORT_JSB_METHOD_INVOKER.call) {
                    results.method3 = window.PASSPORT_JSB_METHOD_INVOKER.call('isInDarkMode', {});
                    log('方式3成功: call 方法', 'success');
                } else {
                    results.method3 = { error: 'call 方法不存在' };
                }
            } catch (error) {
                results.method3 = { error: error.message };
                log(`方式3失败: ${error.message}`, 'error');
            }
            
            showResult('debug-result', results);
        }

        // ===== 测试函数 =====
        
        function testIsInDarkMode() {
            try {
                const result = callJSB('isInDarkMode');
                showResult('basic-result', result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        function testIsInTalkBackMode() {
            try {
                const result = callJSB('isInTalkBackMode');
                showResult('basic-result', result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        function testGetSystemInfo() {
            try {
                const result = callJSB('getSystemInfo');
                showResult('basic-result', result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        function testShowToast() {
            try {
                const result = callJSB('showToast', {
                    text: '这是一个测试 Toast 消息！'
                });
                showResult('ui-result', result);
            } catch (error) {
                showResult('ui-result', { error: error.message });
            }
        }

        function testShowSimpleDialog() {
            try {
                const result = callJSB('showDialog', {
                    title: '提示',
                    message: '这是一个简单的对话框测试',
                    cancelable: true,
                    positiveButton: {
                        text: '确定'
                    }
                });
                showResult('ui-result', result);
            } catch (error) {
                showResult('ui-result', { error: error.message });
            }
        }

        function testShowComplexDialog() {
            try {
                const result = callJSB('showDialog', {
                    title: '复杂对话框',
                    message: '这是一个包含多个按钮的对话框',
                    cancelable: true,
                    positiveButton: {
                        text: '确定'
                    },
                    negativeButton: {
                        text: '取消'
                    },
                    neutralButton: {
                        text: '稍后'
                    }
                });
                showResult('ui-result', result);
            } catch (error) {
                showResult('ui-result', { error: error.message });
            }
        }

        function testStartPage() {
            try {
                const result = callJSB('startPage', {
                    action: 'android.intent.action.VIEW',
                    data: 'https://www.xiaomi.com'
                });
                showResult('page-result', result);
            } catch (error) {
                showResult('page-result', { error: error.message });
            }
        }

        function testStartCustomPage() {
            const url = document.getElementById('custom-url').value;
            if (!url) {
                log('请输入 URL', 'warn');
                return;
            }
            
            try {
                const result = callJSB('startPage', {
                    action: 'android.intent.action.VIEW',
                    data: url
                });
                showResult('page-result', result);
            } catch (error) {
                showResult('page-result', { error: error.message });
            }
        }

        function testClosePage(reason) {
            if (!confirm(`确定要关闭页面吗？(原因: ${reason})`)) {
                return;
            }
            
            try {
                const result = callJSB('closePage', {
                    reason: reason
                });
                showResult('page-result', result);
            } catch (error) {
                showResult('page-result', { error: error.message });
            }
        }

        // ===== 初始化 =====
        
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成', 'info');
            
            const statusEl = document.getElementById('jsb-status');
            
            setTimeout(() => {
                if (checkJSB()) {
                    statusEl.innerHTML = '<span class="status-good">✅ JSB 可用</span>';
                    log('JSB 初始化成功', 'success');
                } else {
                    statusEl.innerHTML = '<span class="status-bad">❌ JSB 不可用</span>';
                    log('JSB 不可用，请在 App 内打开', 'warn');
                }
                
                // 显示当前环境信息
                log(`User Agent: ${navigator.userAgent}`, 'info');
                log(`当前 URL: ${window.location.href}`, 'info');
            }, 1000); // 延迟1秒检查，给JSB注入时间
        });

        // 全局错误处理
        window.addEventListener('error', function(event) {
            log(`页面错误: ${event.error ? event.error.message : event.message}`, 'error');
        });
    </script>
</body>
</html>
